image: python:3.12
stages:
  - format
  - build
  - python
  - test

### =============================================================
### ==============     JOB TEMPLATES    =========================
### =============================================================

.deep_thought_job:
  retry: 0
  tags:
    - deep-thought

.python_parallel_matrix_job:
  extends: .deep_thought_job
  image: "python:$PYTHON_VERSION"
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.8", "3.10", "3.12"]
  before_script:
    - python --version ; pip --version  # For debugging
    - python -m venv $VENV_DIR
    - source "$VENV_DIR/bin/activate" || exit 1
    # l4casadi
    - cd $CI_PROJECT_DIR && git submodule update --recursive --init external/l4casadi || exit 1
    - cd $CI_PROJECT_DIR/external/l4casadi
    - pip install torch>=2.0 --index-url https://download.pytorch.org/whl/cpu || exit 1
    - pip install -r requirements_build.txt || exit 1
    - pip install . --no-build-isolation || exit 1
    # l4acados
    - cd $CI_PROJECT_DIR
    - ls -al external/ || exit 1
    - pip install -e ./external/acados_$PYTHON_VERSION/interfaces/acados_template || exit 1
    - pip install -e .[test] --no-build-isolation || exit 1
    - pip install -e .[gpytorch-exo] || exit 1
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    VENV_DIR: "$CI_PROJECT_DIR/.venv_$PYTHON_VERSION"
  resource_group: deep-thought-l4acados-$PYTHON_VERSION

.pytest_job:
  extends: .python_parallel_matrix_job
  stage: test
  script:
    - pytest --ignore external/
  variables:
    ACADOS_SOURCE_DIR: "$CI_PROJECT_DIR/external/acados_$PYTHON_VERSION"
    LD_LIBRARY_PATH: "$ACADOS_SOURCE_DIR/lib"
  cache:
    - key: pip-cache-$PYTHON_VERSION
      paths:
        - .cache/pip
      policy: pull


### =============================================================
### ==============     FORMATTING STAGE    ======================
### =============================================================

run formatters: # Check whether code adheres to the required formats
  extends: .deep_thought_job
  stage: format
  script:
    - pip install pre-commit && pre-commit install
    - pre-commit run -a

### =============================================================
### ==============     PREPARATION STAGE    =====================
### =============================================================

install acados:
  extends: .deep_thought_job
  image: "python:$PYTHON_VERSION"
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.8", "3.10", "3.12"]
  stage: build
  script:
    - apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y cmake wget
    - mkdir -p $CI_PROJECT_DIR/external/acados/build && cd $CI_PROJECT_DIR/external/acados/build && cmake -DACADOS_PYTHON=ON .. && make install -j4 || exit 1
    - cd $CI_PROJECT_DIR/external/acados/bin && wget https://github.com/acados/tera_renderer/releases/download/v0.0.34/t_renderer-v0.0.34-linux -O t_renderer && chmod +x t_renderer || exit 1
    - cp -R $CI_PROJECT_DIR/external/acados $CI_PROJECT_DIR/external/acados_$PYTHON_VERSION || exit 1
  retry: 0
  tags:
    - deep-thought
  artifacts:
    paths:
      - $CI_PROJECT_DIR/external/acados_$PYTHON_VERSION
    expire_in: 1 day


install python dependencies:
  extends: .python_parallel_matrix_job
  stage: python
  script:
    - python -c "import numpy, gpytorch, acados_template, l4casadi" || exit 1
  cache:
    - key: pip-cache-$PYTHON_VERSION
      paths:
        - .cache/pip
  # needs:
  #   - job: install acados
  #     parallel:
  #       matrix:
  #         - PYTHON_VERSION: ['$[[ matrix.PYTHON_VERSION ]]']

### =============================================================
### ==============     TESTING STAGE    =========================
### =============================================================

run tests:
  extends: .pytest_job
  script:
    - pytest --ignore external/
  resource_group: l4acados_tests
  # needs:
  #   - job: install python dependencies
  #     parallel:
  #       matrix:
  #         - PYTHON_VERSION: ['$[[ matrix.PYTHON_VERSION ]]']
